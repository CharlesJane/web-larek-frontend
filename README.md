# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

### Базовые типы

Вынесенный тип ID карточки

```
type ID = string;
```

Карточка товара

```
interface IProduct {
    _id: ID; 
    description: string;
    image: string;
    title: string;
    category: string;
    price: number | null;
}
```

Расширенный интерфейс для корзины, храним число товаров в ней

```
interface IBasketItem extends IProduct {
    quantity: number;
}
```

Информация о выбранных товарах и общей стоимости

```
export interface IBasketData {
    items: IBasketItem[];
    total: number;
}
```

Информация о заказе

```
export interface IOrder {
    payment: string;
    email: string;
    phone: string;
    address: string;
}
```

Данные о заказе, уходящие к серверу 

```
export interface IOrderData { // 
    payment: string;
    email: string;
    phone: string;
    address: string;
    total: number;
    items: IBasketItem[];
}
```

Данные из полей форм

```
interface IFormState {
    values: Record<string, string>; // храним текущие значения полей
    errors: string | null ; // сохраняем результат валидации
}
```
Данные о товаре, отображаемые в карточке на главной странице

```
type TProductBase = Pick<IProduct, 'image' | 'title' | 'category' | 'price'>;
```

Данные о товаре, отображаемые в карточке в корзине

```
type TProductBasket = Pick<IProduct, 'title' | 'price'>;
```

Данные о способе оплаты и адресе покупателя

```
type TOrderInfo = Pick<IOrder, 'payment' | 'address'>;
```

Контактные данные покупателя - телефон и почта

```
type TOrderContacts = Pick<IOrder, 'email' | 'phone'>;
```

Данные о финальной стоимости товаров из корзины в модалке об успешном заказе

```
type TBasketSuccess = Pick<IOrderData, 'total'>;
```

### Модели бизнес-логики

Интерфейс для коллекции карточек товаров, получает карточку товара

```
interface IProductsModel {
    products: IProduct[];
    getProduct(productId: ID): IProduct;
}
```

Корзина

```
interface IBasketModel {
    total: number;
    items: IBasketItem[];
}
```

Интерфейс для данных заказа

```
interface IOrderModel {
    orderData: IOrder;
}
```

### Компоненты отображения

Интерфейс для рендера карточи товара

```
interface IProductCard {
    render(product: IProduct): HTMLElement;
}
```

Интерфейс для рендера списка карточек и превью выбранной карточки

```
interface IProductsView {
    renderProducts(): void;
    renderPreview(productId: ID): void; 
}
```

Интерфейс для рендера корзины

```
interface IBasketView {
    renderItems(): void;
    renderTotal(): void;
}
```

Интерфейс для рендера форм

```
interface IOrderView {
    renderForm(): void;
}
```

### Презентер

Интерфейс для данных карточки, устанавливает превью и получает id переданной карточки

```
interface IProductsPresenter {
    setPreview(productId: ID): void;
    getPreview(): ID | null;
}
```

Интерфейс для данных корзины, добавляет товар в список, убирает его оттуда, обновляет счетчик, собирает данные о заказе и общей сумме корзины

```
interface IBasketPresenter {
    addItem(product: IProduct): void;
    removeItem(productId: ID): void;
    updateQuantity(productId: ID, quantity: number): void;
    getBasketData(): IBasketData;
    getTotal(): number;
}
```

Интерфейс для данных заказа, устанавливает данные о заказе и валидирует информацию о выбранном способе оплаты, адресе, телефоне и почте заказчика, отправляет данные о полном заказе на сервер

```
interface IOrderPresenter {
    setOrderInfo(orderData: {order: IOrder; basket: IBasketData;}): void; 
    checkOrderInfoValidation(data: Record<keyof (TOrderContacts | TOrderInfo), string>): boolean; // валидируем отправляемые данные
    sendOrder(IOrderData): Promise<void>; 
}
```


### Состояния

Cостояние корзины для дальнейшей работы с представлением

```
interface IBasketState { 
    items: IBasketItem[];
    total: number;
}
```

Общее состояние приложения

```
interface IAppState {
    products: IProductsModel;
    basket: IBasketState;
    order: IOrderModel;
}
```

##  Архитектура приложения 

Код приложения разделен на слои согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице;
- слой данных, отвечает за хранение и изменение данных;
- презентер, отвечает за связь представления и данных;

### Базовый код 

#### Класс Api 
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- 'get' - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- 'post' - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт, переданный как параметр при вызове метода. По умолчанию выполняется 'POST' запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.
Основные методы, реализуемые классом, описаны интерфейсом 'IEvents':
- 'on' - подписка на событие;
- 'emit' - инициализация события;
- 'trigger' - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

### Классы данных
 
#### Класс ProductsList

Класс отвечает за хранение карточек товаров.\
Конструктор класса принимает экземпляр брокера событий.\
В полях класса хранятся следующие данные: 
- _products: IProduct[] - массив карточек продуктов
- _preview: string | null - id карточки, выбранной для просмотра в модальном окне
- events: IEvents - экземпляр класса 'EventEmitter' для инициализации событий при изменении данных

Так же класс предоставляет метод возвращения карточки товара из массива карточек по id: 
- getProduct(productId:string): IProduct
Так же класс предоставляет сеттеры и геттеры для сохранения и получения данных из полей класса.

#### Класс BasketData

Класс отвечает за получение и логику обработки данных заказа.\
Конструктор класса принимает экземпляр брокера событий.\
В полях класса хранятся следующие данные:
- basketList: IProduct[] - массив переданных в корзину карточек товаров
- events: IEvents - экземпляр класса 'EventEmitter' для инициализации событий при изменении данных

Класс предоставляет набор методов для обработки получаемых данных:
- checkBasketValidation(data: Record<keyof TPageTotal, string>): boolean -   проверяет, что в корзине есть товары
- setOrderBasketInfo(basketData: IBasket): void - отправляет данные о выбранных товарах (список) и общую сумму заказа
- deleteProductFromBasket(productID: string): void - удаляет товар из массива айди карточек 

#### Класс OrderData

Класс отвечает за получение и логику обработки данных заказа.\
Конструктор класса принимает экземпляр брокера событий.\
В полях класса хранятся следующие данные:
- events: IEvents - экземпляр класса 'EventEmitter' для инициализации событий при изменении данных

Класс предоставляет набор методов для обработки получаемых данных:
- setOrderInfo(orderData: IOrder): void - отправляет данные, введенные при заказе из полей payment, email, phone и address
- checkOrderInfoValidation(data: Record<keyof (TOrderContacts | TOrderInfo), string>): boolean -  валидирует отправляемые на сервер данные из полей заказа


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс BasketCounter 

Отвечает за отображение общего числа товаров, находящихся в данный момент в корзине, в виджете на главной странице. Конструктор принимает экземпляр 'EventEmitter' для инициации событий.\

Поля класса содержат элемент разметки счетчика, куда передаются данные о количестве товаров в корзине, а так же кнопку, на который устанавливается экземпляр эмиттера. 

Методы класса: 
- setBasketListCount(productCounter: number): number - метод для отображения в разметке кол-ва карточек в корзине

#### Класс ProductCard 

Отвечает за отображение карточки, задавая в карточке данные названия, категории, изображения, описания и цены. Класс используется для отображения карточек на странице сайта и в модальных окнах.\
В конструктор класса передается DOM-элемент темплейта, что позволяет по необходимости формировать разные представления карточки в верстке. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми генерируются соответствующие события.\
Поля класса содержать элементы разметки карточек. Конструктор, кроме темплейта, принимает экземпляр 'EventEmitter' для инициации событий.

Методы: 
- setProduct(productData: IProduct, productId: string): void - заполняет атрибуты элементов карточки данными
- isProductInBasket(productId: string): boolean - управляет элементом кнопки, отображая active/disabled состояния, в зависимости от наличия товара в корзине
- render(): HTMLElement - возвращает полностью заполненную карточку
- геттер id возвращает уникальный id карточки

#### Класс ProductsContainer 
Отвечает за рендер листа с карточками товаров. Получает массив HTML-элементов. Предоставляет метод для отрисовки текущего списка элементов разметки карточек. В конструктор принимает контейнер, в котором размещаются карточки.

#### Класс ModalContainer
Класс реализует рендер html-элемента модального окна, являющегося контейнером для отображаемых элементов интерфейса. Предоставляет методы 'open' и 'close' для управления отображением модального окна, метод 'addContentElement' принимает темплейт отображаемого элемента и отображает его в модальном окне, метод 'addBackdrop' устанавливает затемнение на оверлэй при открытом состоянии окна. \
Устанавливает слушатели на клавиатуру для закрытия окна по Esc, а так же на клик по кнопке-крестику для закрытия модалки.
- constructor(selector: string, events: IEvents, template: string | HTMLTemplateElement) - принимает селектор, по которому идентифицируется отображаемый элемент интерфейса,экземпляр класса 'EventEmitter' для инициалции событий, а так же передаваемый в разметку темплейт для отображения.

Поля класса: 
- modal: HTMLElement - элемент модеального окна
- modalContent: HTMLTemplateElement - элемент отображаемого темплейта
- isOpen: boolean - хранит состояние модального окна
- backdrop: HTMLElement -  хранит элемент затемнения оверлея
- events: IEvents - брокер событий

#### Класс Basket

Класс реализует отображение корзины с выводом списка добавленных в нее карточек товаров. При нажатии на кнопку инициирует событие, передавая в него объект корзины (данные о списке переданных карточек и общей сумме).

Поля класса:
- basketList: HTMLOListElement - элемент разметки, принимающий в поля списка элементы разметки карточек
- basketButton: HTMLButtonElement - элемент кнопки для оформления заказа

Методы класса:
- renderProductsList(products: TProductBasket): HTMLElement - метод установки списка элементов карточек, отображаемых в корзине
- isBasketEmpty(productCount: number): boolean - управляет элементом кнопки, отображая active/disabled состояния, в зависимости от количества товара в корзине (равно или больше 0)


#### Класс OrderForm
Класс реализует форму для получения данных из полей ввода. При нажатии на кнопку инициирует событие, передавая в него объект с данными из полей ввода формы.\
При изменении данных в полях ввода инициирует событие изменения данных. Предоставляет методы для отображения ошибок и управления доступностью кнопки.

Поля класса:
- template: HTMLTemplateElement - темплейт-элемент
- submitButton: HTMLButtonElement - кнопка для перехода к следующему окну и сохранения данных
- _form: HTMLFormELement - элемент формы
- selectButtonCard?: HTMLButtonElement - элемент кнопки для переключения между способами оплаты
- selectButtonCash?: HTMLButtonElement - элемент кнопки для переключения между способами оплаты
- inputs: NodeListOf<HTMLInputElement> - коллекция всех полей ввода формы
- errors: Record<string, HTMLElement> - объект, хранящий все элементы для вывода ошибок под полями формы c привязкой к атрибуту name инпутов

Методы:
- setValid(isValid: boolean): void - управляет активностью кнопки
- submitForm(submitButton: HTMLButtonElement, getInputValues()): string[] - сохраняет данные формы и переходит на следующий экран
- isSelected(paymentType: HTMLButtonElement.name): boolean - возвращает состояние кнопки выбора
- setError(data: { field: string, value: string, validInfo: string }): void - принимает объект с данными для отображения или сокрытия текстов ошибок под полями ввода
- showInputError(field: string, errorMessage: string): void - отображает полученный текст ошибки под указанным полем ввода
- hideInputError(field: string): void - очищает текст ошибки под указанным полем ввода
- clear(): void - очищает поля ввода и деактивирует кнопку продолжения

#### Класс OrderSuccess
Класс реализует окно-результат уведомления об успешном действии. При нажатии на кнопку инициирует событие, передающее информацию модальному окну о закрытии. 

Поля класса:
- totalElement: HTMLElenment - элемент разметки, отображающий финальную сумму заказа
- buttonElement: HTMLButtonElement - элемент кнопки для возвращения к каталогу 

Методы класса:
- returnToMain(): void - передает информацию о событии модальному окну для закрытия модалки

### Классы коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы, реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой, находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий, генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`.\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

### *Список всех событий, коорые могут генерироваться в системе:*
*События изменения данных (генерируются моделями данных)*
- `productsList:changed` - изменение списка товаров
- `productCard:selected` - изменение отображаемой в модальном окне карточки
- `orderData:changed` - изменения данных заказа

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируется классами, отвечающими за представление)*
- `card-preview:open` - открытие модального окна с предпросмотром карточки товара
- `basket:open` - открытие модального окна с корзиной с главной страницы
- `order:open` - открытие модального окна с заполнением данных о заказе
- `contacts:open` - открытие модального окна с заполнением данных о покупателе
- `success:open` - открытие модального окна с уведомлением об успешной оплате
- `card-catalog:select` - выбор карточки для отображения в модальном окне
- `card-basket:delete` - выбор карточки для удаления из корзины
- `basket:proceed` - событие перехода на следующий этап оформления заказа из корзины и сохранение данных
- `order:submit` - событие перехода на следующий этап оформления заказа из формы данных об оплате и сохранение данных
- `contacts:submit` - событие перехода к окну уведомления об успешном заказе и сохранение данных
- `success:proceed` - закрытие модального окна с уведомлением об успешном заказе
- `buttonCard:select` - выбор способа оплаты онлайн
- `buttonCash:select` - выбор способа оплаты наличными
- `order:input` - изменение данных в форме заказа товаров
- `contacts:input` - изменение данных в форме контактных данных
- `basket:validation` - событие, сообщающее о необходимости валидации корзины - товары больше 0
- `order:validation` - событие, сообщающее о необходимости валидации заказа - выбран способ оплаты, поле с адресом заполнено корректно
- `contacts:validation` - событие, сообщающее о необходимости валидации контактов - оба поля заполнены корректно
- `order:clear` - необходима очистка полей способа оплаты и адреса перед переходом к другому окну или закрытии модального окна
- `basket:clear` - необходима очистка списка товаров перед переходом к другому окну или закрытии модального окна
- `contacts:clear` - необходима очистка полей контактных данных перед переходом к другому окну или закрытии модального окна
- `card-preview:clear` - необходима очистка карточки, передаваемой для просмотра перед закрытием модального окна
- `modal:close` - закрытие модального окна по кнопке с крестиком
- `modal:closeByEscape` - закрытие модального окна по Esc
- `userOrder:updated` - обновление данных пользователя 
- `userOrder:ready` - данные пользователя валидированы и готовы к передаче
- `userOrder:cleared` - очищены данные пользователя после валидации и передачи
- `basket:added`  - продукт добавлен в корзину
- `basket:deleted` - продукт удален из корзины
- `basket:cleared` - корзина очищена